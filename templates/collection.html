<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Collection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.6.1/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .site-card {
            background-color: #1e1e1e;
            color: #ffffff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .site-card:hover {
            background-color: #333333;
        }
        .site-card img {
            max-height: 100px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        .site-card h2 {
            margin: 0;
            display: none;
        }
        .site-card .no-logo h2 {
            display: block;
        }
        .site-card button {
            background-color: #ff5f6d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: block; 
            margin-top: 20px;
        }
        .site-card button.remove {
            background-color: red;
        }
        .highlight-missing {
            background-color: red !important;
        }
        .highlight-found {
            background-color: green !important;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background-color: #333;
            color: white;
        }
        .file-path-icon {
            color: green;
            margin-right: 5px;
            font-size: 1em;
        }
        .match-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }
        .scene-count {
            text-align: center;
            margin-bottom: 10px;
            margin-top: 10px;
            font-size: 1.2em;
        }
        .site-logo img {
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        #compare-container.compare-container {
            text-align: center;
        }
        .btn-dark-mode {
            background-color: #333;
            color: white;
        }
        .btn-dark-mode:hover {
            background-color: #444;
        }
        .table-dark-mode {
            background-color: #1e1e1e;
            color: white;
        }
        #site-logo {
        text-align: center;
        max-width: 100%;
        max-height: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Jizzarr Home</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/collection">My Collection</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <div id="site-collection" class="row g-4"></div>
        <div id="scene-collection" class="d-none">
            <div id="back-button-container" class="mb-3">
                <button id="back-button" class="btn btn-secondary">Back to Sites</button>
            </div>
            <div class="site-logo" id="site-logo"></div>
            <div class="scene-count" id="scene-count"></div>
            <div class="match-controls">
                <div>
                    <label for="page-size">Results per page:</label>
                    <select id="page-size" class="form-select w-auto d-inline-block">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <button id="toggle-matches" class="btn btn-primary">Show Only Matched Scenes</button>
                <button id="set-home-directory-button" class="btn btn-primary">Set Home Directory</button>
                <button id="suggest-matches-button" class="btn btn-primary">Suggest Matches</button>
                <button id="bulk-update-button" class="btn btn-primary">Bulk Update Matches</button>
            </div>
            <div id="compare-container" class="compare-container mt-3">
                <h4>Current Home Directory:</h4>
                <h5><span id="home-directory-display"></span></h5>
            </div>
            <table class="table table-dark-mode">
                <thead>
                    <tr>
                        <th data-column="title">Title</th>
                        <th data-column="date">Release Date</th>
                        <th data-column="duration">Duration</th>
                        <th data-column="performers">Performers</th>
                        <th data-column="status">Status</th>
                        <th data-column="file_path">File Directory</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="scene-table-body"></tbody>
            </table>
            <div class="pagination-controls d-flex justify-content-center mt-4">
                <button id="first-page" class="btn btn-outline-secondary me-2">First</button>
                <button id="prev-page" class="btn btn-outline-secondary me-2">Prev</button>
                <button id="next-page" class="btn btn-outline-secondary me-2">Next</button>
                <button id="last-page" class="btn btn-outline-secondary">Last</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.6.1/toastify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/fontawesome.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const siteCollectionContainer = document.getElementById('site-collection');
            const sceneCollectionContainer = document.getElementById('scene-collection');
            const backButton = document.getElementById('back-button');
            const sceneTableBody = document.getElementById('scene-table-body');
            const firstPageButton = document.getElementById('first-page');
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            const lastPageButton = document.getElementById('last-page');
            const setHomeDirectoryButton = document.getElementById('set-home-directory-button');
            const suggestMatchesButton = document.getElementById('suggest-matches-button');
            const bulkUpdateButton = document.getElementById('bulk-update-button');
            const pageSizeSelect = document.getElementById('page-size');
            const homeDirectoryDisplay = document.getElementById('home-directory-display');
            const toggleMatchesButton = document.getElementById('toggle-matches');
            const siteLogoContainer = document.getElementById('site-logo');
            const sceneCountDisplay = document.getElementById('scene-count');
            const compareContainer = document.getElementById('compare-container');

            let selectedDirectoryPath = '';
            let currentSiteUuid = '';
            let homeDirectory = '';
            let currentPage = 1;
            let scenesPerPage = parseInt(pageSizeSelect.value, 10);
            let currentScenes = [];
            let sortColumn = '';
            let sortDirection = 'asc';
            let showOnlyMatches = false;
            let suggestedMatches = [];
            let excludedMatches = new Set();  // Set to store excluded matches

            setHomeDirectoryButton.addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Enter home directory path';
                input.classList.add('form-control', 'mt-2');
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.classList.add('btn', 'btn-primary', 'mt-2');
                saveButton.addEventListener('click', async () => {
                    selectedDirectoryPath = input.value.replace(/\\/g, '/');
                    console.log('Selected directory:', selectedDirectoryPath);

                    try {
                        const response = await fetch('/set_home_directory', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ site_uuid: currentSiteUuid, directory: selectedDirectoryPath })
                        });

                        const result = await response.json();
                        if (response.ok) {
                            homeDirectory = selectedDirectoryPath;
                            homeDirectoryDisplay.textContent = homeDirectory;
                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                            }).showToast();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        console.error('Error setting home directory:', error);
                        Toastify({
                            text: 'Error setting home directory: ' + error.message,
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                        }).showToast();
                    }
                });
                compareContainer.innerHTML = ''; // Clear previous inputs
                compareContainer.appendChild(input);
                compareContainer.appendChild(saveButton);
            });

            suggestMatchesButton.addEventListener('click', async function() {
                try {
                    const response = await fetch('/suggest_matches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ site_uuid: currentSiteUuid, tolerance: 95 })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }

                    suggestedMatches = await response.json();
                    suggestedMatches.forEach(match => {
                        const row = document.querySelector(`tr[data-scene-id='${match.scene_id}']`);
                        if (row) {
                            const filePathCell = row.querySelector('td[data-column="file_path"]');
                            const cleanFilePath = match.suggested_file.replace(homeDirectory, '');
                            filePathCell.innerHTML = `<i class="fa-regular fa-square-check file-path-icon"></i>${cleanFilePath}`;
                            const confirmButton = document.createElement('button');
                            confirmButton.textContent = 'Confirm';
                            confirmButton.classList.add('btn', 'btn-success', 'me-2');
                            confirmButton.addEventListener('click', async () => {
                                try {
                                    const response = await fetch('/match_scene', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ scene_id: match.scene_id, file_path: cleanFilePath })
                                    });

                                    if (!response.ok) {
                                        const errorText = await response.text();
                                        throw new Error(`Error ${response.status}: ${errorText}`);
                                    }

                                    const result = await response.json();
                                    Toastify({
                                        text: result.message,
                                        duration: 3000,
                                        close: true,
                                        gravity: "top",
                                        position: "right",
                                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                                    }).showToast();
                                } catch (error) {
                                    console.error('Error confirming match:', error);
                                    Toastify({
                                        text: 'Error confirming match: ' + error.message,
                                        duration: 3000,
                                        close: true,
                                        gravity: "top",
                                        position: "right",
                                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                                    }).showToast();
                                }
                            });
                            const cancelButton = document.createElement('button');
                            cancelButton.textContent = 'Cancel';
                            cancelButton.classList.add('btn', 'btn-danger');
                            cancelButton.addEventListener('click', () => {
                                filePathCell.innerHTML = '';
                                excludedMatches.add(match.scene_id);  // Add scene ID to excluded matches
                            });
                            filePathCell.appendChild(confirmButton);
                            filePathCell.appendChild(cancelButton);
                        }
                    });
                } catch (error) {
                    console.error('Error suggesting matches:', error);
                    Toastify({
                        text: 'Error suggesting matches: ' + error.message,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                    }).showToast();
                }
            });

            bulkUpdateButton.addEventListener('click', async function() {
                for (const match of suggestedMatches) {
                    if (excludedMatches.has(match.scene_id)) {
                        continue;  // Skip if the match was excluded
                    }
                    try {
                        const response = await fetch('/match_scene', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ scene_id: match.scene_id, file_path: match.suggested_file })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Error ${response.status}: ${errorText}`);
                        }

                        const result = await response.json();
                    } catch (error) {
                        console.error('Error confirming match:', error);
                        Toastify({
                            text: 'Error confirming match: ' + error.message,
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                        }).showToast();
                    }
                }
                displayScenes();
                Toastify({
                    text: 'All matches confirmed!',
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                }).showToast();
            });

            toggleMatchesButton.addEventListener('click', () => {
                showOnlyMatches = !showOnlyMatches;
                displayScenes();
            });

            async function displayCollection() {
                siteCollectionContainer.innerHTML = '';

                const response = await fetch('/collection_data');
                const siteCollection = await response.json();

                siteCollection.forEach(item => {
                    const siteCard = document.createElement('div');
                    siteCard.classList.add('col-md-4');
                    siteCard.innerHTML = `
                        <div class="card h-100 site-card ${item.site.logo ? '' : 'no-logo'}">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    ${item.site.logo ? 
                                        `<div class="ms-auto">
                                            <img src="${item.site.logo}" class="max-h-24 object-contain" alt="${item.site.name}">
                                        </div>` : 
                                        `<h2 class="card-title">${item.site.name}</h2>`}
                                </div>
                                <button class="btn btn-danger remove-site-button" data-site-uuid="${item.site.uuid}">Remove</button>
                            </div>
                        </div>
                    `;
                    siteCard.addEventListener('click', () => {
                        currentSiteUuid = item.site.uuid;
                        homeDirectory = item.site.home_directory || '';
                        homeDirectoryDisplay.textContent = homeDirectory;
                        siteLogoContainer.innerHTML = item.site.logo ? `<img src="${item.site.logo}" alt="${item.site.name}">` : '';
                        siteCollectionContainer.classList.add('d-none');
                        sceneCollectionContainer.classList.remove('d-none');
                        showScenesForSite(item.scenes);
                    });
                    siteCollectionContainer.appendChild(siteCard);
                });

                document.querySelectorAll('.remove-site-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const siteUuid = e.target.getAttribute('data-site-uuid');
                        await removeSiteFromCollection(siteUuid);
                    });
                });
            }

            async function removeSiteFromCollection(siteUuid) {
                const response = await fetch(`/remove_site/${siteUuid}`, { method: 'DELETE' });
                const data = await response.json();
                console.log('Site removed:', data);
                Toastify({
                    text: 'Site has been removed from your collection.',
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                }).showToast();
                displayCollection();
            }

            function showScenesForSite(scenes) {
                currentScenes = scenes;
                currentPage = 1;
                updateSceneCount();
                displayScenes();
                updatePaginationButtons();
            }

            function displayScenes() {
                sceneTableBody.innerHTML = '';
                const filteredScenes = showOnlyMatches ? currentScenes.filter(scene => scene.status === 'Found') : currentScenes;
                const sortedScenes = sortScenes(filteredScenes);
                const scenesToDisplay = sortedScenes.slice((currentPage - 1) * scenesPerPage, currentPage * scenesPerPage);

                scenesToDisplay.forEach(scene => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-scene-id', scene.id);
                    row.innerHTML = `
                        <td>${scene.title}</td>
                        <td>${scene.date}</td>
                        <td>${formatDuration(scene.duration)}</td>
                        <td>${formatPerformers(scene.performers)}</td>
                        <td>${scene.status === null ? 'Missing' : scene.status}</td>
                        <td data-column="file_path">${scene.local_path ? `<i class="fa-regular fa-square-check file-path-icon"></i>${scene.local_path}` : ''}</td>
                        <td><button class="btn btn-primary match-button">Match</button></td>
                    `;
                    row.querySelector('.match-button').addEventListener('click', () => handleMatchButtonClick(scene));
                    sceneTableBody.appendChild(row);
                });
            }

            function sortScenes(scenes) {
                if (sortColumn) {
                    return scenes.sort((a, b) => {
                        let valA = a[sortColumn];
                        let valB = b[sortColumn];

                        if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                        }
                        if (typeof valB === 'string') {
                            valB = valB.toLowerCase();
                        }

                        if (valA < valB) {
                            return sortDirection === 'asc' ? -1 : 1;
                        }
                        if (valA > valB) {
                            return sortDirection === 'asc' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return scenes;
            }

            function updateSceneCount() {
                const totalScenes = currentScenes.length;
                const matchedScenes = currentScenes.filter(scene => scene.status === 'Found').length;
                sceneCountDisplay.textContent = `${matchedScenes}/${totalScenes} scenes in collection`;
            }

            document.querySelectorAll('th').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-column');
                    if (column) {
                        if (sortColumn === column) {
                            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortColumn = column;
                            sortDirection = 'asc';
                        }
                        displayScenes();
                    }
                });
            });

            pageSizeSelect.addEventListener('change', () => {
                scenesPerPage = parseInt(pageSizeSelect.value, 10);
                displayScenes();
                updatePaginationButtons();
            });

            function formatDuration(minutes) {
                const hrs = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hrs > 0 ? hrs + 'h ' : ''}${mins}m`;
            }

            function formatPerformers(performers) {
                return Array.isArray(performers) ? performers.join(', ') : performers;
            }

            async function handleMatchButtonClick(scene) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.mp4';
                input.onchange = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        try {
                            const response = await fetch('/match_scene', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ scene_id: scene.id, file_path: file.webkitRelativePath || file.name })
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`Error ${response.status}: ${errorText}`);
                            }

                            const result = await response.json();
                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                            }).showToast();
                            displayScenes();
                        } catch (error) {
                            console.error('Error matching scene:', error);
                            Toastify({
                                text: 'Error matching scene: ' + error.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                            }).showToast();
                        }
                    }
                };
                input.click();
            }

            function updatePaginationButtons() {
                const totalPages = Math.ceil(currentScenes.length / scenesPerPage);
                firstPageButton.disabled = currentPage === 1;
                prevPageButton.disabled = currentPage === 1;
                nextPageButton.disabled = currentPage === totalPages;
                lastPageButton.disabled = currentPage === totalPages;

                firstPageButton.classList.toggle('disabled', currentPage === 1);
                prevPageButton.classList.toggle('disabled', currentPage === 1);
                nextPageButton.classList.toggle('disabled', currentPage === totalPages);
                lastPageButton.classList.toggle('disabled', currentPage === totalPages);
            }

            firstPageButton.addEventListener('click', () => {
                currentPage = 1;
                displayScenes();
                updatePaginationButtons();
            });

            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayScenes();
                    updatePaginationButtons();
                }
            });

            nextPageButton.addEventListener('click', () => {
                const totalPages = Math.ceil(currentScenes.length / scenesPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    displayScenes();
                    updatePaginationButtons();
                }
            });

            lastPageButton.addEventListener('click', () => {
                currentPage = Math.ceil(currentScenes.length / scenesPerPage);
                displayScenes();
                updatePaginationButtons();
            });

            backButton.addEventListener('click', () => {
                siteCollectionContainer.classList.remove('d-none');
                sceneCollectionContainer.classList.add('d-none');
            });

            displayCollection();
        });
    </script>
</body>
</html>

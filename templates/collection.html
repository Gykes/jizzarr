<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Collection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.6.1/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .site-card {
            background-color: #1e1e1e;
            color: #ffffff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            margin-top: 50px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .site-card:hover {
            background-color: #333333;
        }
        .site-title {
            text-align: center;
        }
        .site-card img {
            max-width: 100%;
            max-height: 100px;
            object-fit: contain;
            margin-right: 10px;
            border-radius: 4px;
        }
        .site-card h2 {
            margin: 0;
            display: none;
        }
        .site-card .no-logo h2 {
            display: block;
        }
        .site-card button {
            background-color: #ff5f6d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: block;
            margin-top: 20px;
        }
        .site-card button.remove {
            background-color: red;
        }
        .highlight-missing {
            background-color: red !important;
        }
        .highlight-found {
            background-color: green !important;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background-color: #333;
            color: white;
        }
        .file-path-icon {
            color: green;
            margin-right: 5px;
            font-size: 1em;
        }
        .match-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
        }
        .scene-count {
            text-align: center;
            margin-bottom: 10px;
            margin-top: 10px;
            font-size: 1.2em;
        }
        .site-logo img {
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        #compare-container.compare-container {
            text-align: center;
        }
        #back-button-container {
            margin-top: 25px;
        }
        .btn-dark-mode {
            background-color: #333;
            color: white;
        }
        .btn-dark-mode:hover {
            background-color: #444;
        }
        .table-dark-mode {
            background-color: #1e1e1e;
            color: white;
        }
        #site-logo {
            text-align: center;
            max-width: 100%;
            max-height: 100%;
        }
        .action-buttons {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 5px; /* Adjust this value as needed */
        }
        .highlight-found {
            background-color: green;
            color: white;
        }
        .custom-navbar {
            width: 100%;
            position: fixed;
            top: 0;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(6px);
        }
        .custom-navbar a {
            color: #ffffff;
            text-decoration: none;
            margin: 0 10px;
            padding: 5px 10px;
        }
        .custom-navbar a:hover {
            background-color: #495057;
            border-radius: 4px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .site-card {
                flex-direction: column;
                align-items: flex-start;
            }
            .site-card img {
                max-width: 100%;
                margin: 0 0 10px 0;
            }
            .match-controls {
                flex-direction: column;
                gap: 10px;
            }
            .table-dark-mode th, .table-dark-mode td {
                padding: 5px;
                font-size: 0.8em;
            }
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
        }
        @media (max-width: 576px) {
            .site-card {
                padding: 10px 5px;
            }
            .match-controls {
                gap: 5px;
            }
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <nav class="custom-navbar">
        <a href="{{ url_for('index') }}">Jizzarr Home</a>
        <a href="{{ url_for('collection') }}">My Collection</a>
        <a href="{{ url_for('config_page') }}">Settings</a>
        <a href="{{ url_for('logs') }}">Logs</a>
    </nav>
    <div class="container mt-4">
        <div class="mb-3">
            <input type="text" id="search-input" class="form-control" placeholder="Search by site name...">
            <button id="search-button" class="btn btn-primary mt-2">Search</button>
        </div>
        <div id="site-collection" class="row g-4"></div>
        <div class="pagination-controls d-flex justify-content-center mt-4">
            <button id="first-page" class="btn btn-outline-secondary me-2">First</button>
            <button id="prev-page" class="btn btn-outline-secondary me-2">Prev</button>
            <button id="next-page" class="btn btn-outline-secondary me-2">Next</button>
            <button id="last-page" class="btn btn-outline-secondary">Last</button>
        </div>
        <div id="scene-collection" class="d-none">
            <div id="back-button-container" class="mb-3">
                <button id="back-button" class="btn btn-secondary">Back to Sites</button>
            </div>
            <div class="site-logo" id="site-logo"></div>
            <p class="site-title" id="site-title"></p>
            <div class="scene-count" id="scene-count"></div>
            <div class="match-controls">
                <div>
                    <label for="page-size">Results per page:</label>
                    <select id="page-size" class="form-select w-auto d-inline-block">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                    </select>
                </div>
                <button id="toggle-matches" class="btn btn-primary">Show Only Matched Scenes</button>
                <button id="set-home-directory-button" class="btn btn-primary">Set Home Directory</button>
                <button id="suggest-matches-button" class="btn btn-primary">Suggest Matches</button>
                <button id="bulk-update-button" class="btn btn-primary">Bulk Update Matches</button>
                <button id="search-stash-button" class="btn btn-primary">Search Stash for Matches</button>
            </div>
            <div id="compare-container" class="compare-container mt-3">
                <h4>Current Home Directory:</h4>
                <h5><span id="home-directory-display"></span></h5>
            </div>
            <table class="table table-dark-mode">
                <thead>
                    <tr>
                        <th data-column="title">Title</th>
                        <th data-column="date">Release Date</th>
                        <th data-column="duration">Duration</th>
                        <th data-column="performers">Performers</th>
                        <th data-column="status">Status</th>
                        <th data-column="file_path">File Directory</th>
                        <th data-column="foreign_guid">TPDB Scene UUID</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="scene-table-body"></tbody>
            </table>
            <div class="pagination-controls d-flex justify-content-center mt-4">
                <button id="first-page" class="btn btn-outline-secondary me-2">First</button>
                <button id="prev-page" class="btn btn-outline-secondary me-2">Prev</button>
                <button id="next-page" class="btn btn-outline-secondary me-2">Next</button>
                <button id="last-page" class="btn btn-outline-secondary">Last</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.6.1/toastify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/fontawesome.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const siteCollectionContainer = document.getElementById('site-collection');
            const sceneCollectionContainer = document.getElementById('scene-collection');
            const backButton = document.getElementById('back-button');
            const sceneTableBody = document.getElementById('scene-table-body');
            const firstPageButton = document.getElementById('first-page');
            const prevPageButton = document.getElementById('prev-page');
            const nextPageButton = document.getElementById('next-page');
            const lastPageButton = document.getElementById('last-page');
            const setHomeDirectoryButton = document.getElementById('set-home-directory-button');
            const suggestMatchesButton = document.getElementById('suggest-matches-button');
            const bulkUpdateButton = document.getElementById('bulk-update-button');
            const pageSizeSelect = document.getElementById('page-size');
            const homeDirectoryDisplay = document.getElementById('home-directory-display');
            const toggleMatchesButton = document.getElementById('toggle-matches');
            const siteLogoContainer = document.getElementById('site-logo');
            const siteTitleContainer = document.getElementById('site-title');
            const sceneCountDisplay = document.getElementById('scene-count');
            const compareContainer = document.getElementById('compare-container');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');

            let selectedDirectoryPath = '';
            let currentSiteUuid = '';
            let homeDirectory = '';
            let currentPage = 1;
            let scenesPerPage = parseInt(pageSizeSelect.value, 10);
            let currentScenes = [];
            let sortColumn = '';
            let sortDirection = 'asc';
            let showOnlyMatches = false;
            let suggestedMatches = [];
            let excludedMatches = new Set();  // Set to store excluded matches
            let enableBulkUpdate = true;
            let totalPages = 1;

            setHomeDirectoryButton.addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Enter home directory path';
                input.classList.add('form-control', 'mt-2');
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.classList.add('btn', 'btn-primary', 'mt-2');
                saveButton.addEventListener('click', async () => {
                    selectedDirectoryPath = input.value.replace(/\\/g, '/');
                    console.log('Selected directory:', selectedDirectoryPath);

                    try {
                        const response = await fetch('/set_home_directory', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ site_uuid: currentSiteUuid, directory: selectedDirectoryPath })
                        });

                        const result = await response.json();
                        if (response.ok) {
                            homeDirectory = selectedDirectoryPath;
                            homeDirectoryDisplay.textContent = homeDirectory;
                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                            }).showToast();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        console.error('Error setting home directory:', error);
                        Toastify({
                            text: 'Error setting home directory: ' + error.message,
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                        }).showToast();
                    }
                });
                compareContainer.innerHTML = ''; // Clear previous inputs
                compareContainer.appendChild(input);
                compareContainer.appendChild(saveButton);
            });

            suggestMatchesButton.addEventListener('click', async function() {
                try {
                    const response = await fetch('/suggest_matches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ site_uuid: currentSiteUuid, tolerance: 95 })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error ${response.status}: ${errorText}`);
                    }

                    suggestedMatches = await response.json();
                    const matchedScenes = [];

                    suggestedMatches.forEach(match => {
                        const scene = currentScenes.find(scene => scene.id === match.scene_id);
                        if (scene && !matchedScenes.find(s => s.id === scene.id)) {
                            matchedScenes.push(scene);
                            scene.suggested_file = match.suggested_file; // Store suggested file in scene object
                        }
                    });

                    currentScenes = matchedScenes;
                    displayScenesWithActions();
                    enableBulkUpdate = false; // Disable bulk update button
                    bulkUpdateButton.disabled = true;
                } catch (error) {
                    console.error('Error suggesting matches:', error);
                    Toastify({
                        text: 'Error suggesting matches: ' + error.message,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                    }).showToast();
                }
            });

            function displayScenesWithActions() {
                sceneTableBody.innerHTML = '';
                const sortedScenes = sortScenes(currentScenes);
            
                sortedScenes.forEach(scene => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-scene-id', scene.id);
                    const cleanFilePath = scene.suggested_file ? scene.suggested_file.replace(homeDirectory, '') : '';
                    row.innerHTML = `
                        <td>${scene.title}</td>
                        <td>${scene.date}</td>
                        <td>${formatDuration(scene.duration)}</td>
                        <td>${formatPerformers(scene.performers)}</td>
                        <td>${scene.status === null ? '<i class="fa-solid fa-triangle-exclamation" style="color: red;"></i> Missing' : scene.status}</td>
                        <td data-column="file_path">${scene.local_path ? `<i class="fa-regular fa-square-check file-path-icon"></i>${scene.local_path}` : cleanFilePath}</td>
                        <td data-column="action" class="action-buttons">
                            <button class="btn btn-success me-2 confirm-match">Confirm</button>
                            <button class="btn btn-danger cancel-match">Cancel</button>
                        </td>
                    `;
            
                    row.querySelector('.confirm-match').addEventListener('click', async () => {
                        try {
                            const fullFilePath = `${cleanFilePath}`;
                            const response = await fetch('/match_scene', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ scene_id: scene.id, file_path: fullFilePath })
                            });
            
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`Error ${response.status}: ${errorText}`);
                            }
            
                            const result = await response.json();
                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                            }).showToast();
            
                            // Update the local status and file path of the scene
                            scene.status = 'Found';
                            scene.local_path = fullFilePath;
            
                            // Update the specific row in the table
                            row.querySelector('td[data-column="file_path"]').innerHTML = `<i class="fa-regular fa-square-check file-path-icon"></i>${fullFilePath}`;
                            row.querySelector('td[data-column="file_path"]').classList.add('highlight-found');
                            row.querySelector('td[data-column="action"]').innerHTML = ''; // Remove the action buttons after confirmation
                        } catch (error) {
                            console.error('Error confirming match:', error);
                            Toastify({
                                text: 'Error confirming match: ' + error.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                            }).showToast();
                        }
                    });
            
                    row.querySelector('.cancel-match').addEventListener('click', () => {
                        const filePathCell = row.querySelector('td[data-column="file_path"]');
                        filePathCell.innerHTML = '';
                        excludedMatches.add(scene.id);
                        const actionCell = row.querySelector('td[data-column="action"]');
                        actionCell.innerHTML = '';
                    });
            
                    sceneTableBody.appendChild(row);
                });
            }

            bulkUpdateButton.addEventListener('click', async function() {
                if (!enableBulkUpdate) {
                    Toastify({
                        text: 'Bulk update is disabled for suggested matches.',
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                    }).showToast();
                    return;
                }
            
                let matchesToProcess = [...suggestedMatches];
            
                document.querySelectorAll('tr').forEach(row => {
                    const foreignGuidCell = row.querySelector('td[data-column="foreign_guid"]');
                    const filePathCell = row.querySelector('td[data-column="file_path"]');
                    if (foreignGuidCell && filePathCell && filePathCell.textContent.trim() !== '') {
                        matchesToProcess.push({
                            foreign_guid: foreignGuidCell.textContent.trim(),
                            matched_file_path: filePathCell.textContent.trim().replace(/.*\((.*)\)/, '$1'),
                            scene_id: row.getAttribute('data-scene-id')
                        });
                    }
                });
            
                for (const match of matchesToProcess) {
                    if (excludedMatches.has(match.scene_id)) {
                        continue;  // Skip if the match was excluded
                    }
                    try {
                        const response = await fetch('/match_scene', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ scene_id: match.scene_id, file_path: match.matched_file_path })
                        });
            
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Error ${response.status}: ${errorText}`);
                        }
            
                        const result = await response.json();
            
                        // Update the local status of the scene to 'Found'
                        const scene = currentScenes.find(s => s.id == match.scene_id);
                        if (scene) {
                            scene.status = 'Found';
                            scene.local_path = match.matched_file_path; // No need to prepend home directory
                        }
                    } catch (error) {
                        console.error('Error confirming match:', error);
                        Toastify({
                            text: 'Error confirming match: ' + error.message,
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                        }).showToast();
                    }
                }
                displayScenes();
                Toastify({
                    text: 'All matches confirmed!',
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                }).showToast();
            });

            function enableBulkUpdateButton() {
                enableBulkUpdate = true;
                bulkUpdateButton.disabled = false;
            }

            async function displayCollection(page = 1, filteredCollection = null) {
                siteCollectionContainer.innerHTML = '';

                const response = await fetch(`/collection_data?page=${page}&per_page=12`);
                const data = await response.json();
                const siteCollection = data.collection_data;
                totalPages = data.total_pages;
                currentPage = data.current_page;

                if (!Array.isArray(siteCollection)) {
                    console.error('Expected an array but got:', siteCollection);
                    return;
                }

                const collectionData = filteredCollection || siteCollection;

                collectionData.forEach(item => {
                    const totalScenes = item.total_scenes;
                    const collectedScenes = item.collected_scenes;
                    const progressPercentage = totalScenes > 0 ? (collectedScenes / totalScenes) * 100 : 0;
                    const logoUrl = item.site.logo;

                    console.log('Total Scenes:', totalScenes); // Debugging line
                    console.log('Collected Scenes:', collectedScenes); // Debugging line

                    const siteCard = document.createElement('div');
                    siteCard.classList.add('col-md-4');
                    siteCard.innerHTML = `
                        <div class="card h-100 site-card ${logoUrl ? '' : 'no-logo'}">
                            <div class="card-body">
                                <div class="d-flex flex-column align-items-center">
                                    ${logoUrl ? 
                                        `<img src="${logoUrl}" class="max-h-24 object-contain mb-3" alt="${item.site.name}" onerror="this.onerror=null;this.src='default_image.png';">` : 
                                        ''}
                                    <h2 class="site-title">${item.site.name}</h2>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-inner" style="width: ${progressPercentage}%;"></div>
                                    <div class="progress-bar-text">${collectedScenes} / ${totalScenes}</div>
                                </div>
                                <button class="btn btn-danger remove-site-button" data-site-uuid="${item.site.uuid}">Remove</button>
                            </div>
                        </div>
                    `;

                    siteCard.addEventListener('click', () => {
                        currentSiteUuid = item.site.uuid;  // Update currentSiteUuid here
                        homeDirectory = item.site.home_directory || '';
                        homeDirectoryDisplay.textContent = homeDirectory;
                        siteLogoContainer.innerHTML = logoUrl ? `<img src="${logoUrl}" alt="${item.site.name}">` : '';
                        siteTitleContainer.innerText = item.site.name;
                        siteCollectionContainer.classList.add('d-none');
                        sceneCollectionContainer.classList.remove('d-none');
                        showScenesForSite(item.scenes);
                    });

                    siteCollectionContainer.appendChild(siteCard);
                });

                document.querySelectorAll('.remove-site-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const siteUuid = e.target.getAttribute('data-site-uuid');
                        await removeSiteFromCollection(siteUuid);
                    });
                });

                updatePaginationButtons();
            }

            async function removeSiteFromCollection(siteUuid) {
                const response = await fetch(`/remove_site/${siteUuid}`, { method: 'DELETE' });
                const data = await response.json();
                console.log('Site removed:', data);
                Toastify({
                    text: 'Site has been removed from your collection.',
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                }).showToast();
                displayCollection(currentPage);
            }

            function showScenesForSite(scenes) {
                currentScenes = scenes.map(scene => {
                    return {
                        ...scene,
                        status: scene.status || 'Missing'  // Set default status to 'Missing'
                    };
                });
                currentScenes = sortScenes(currentScenes, 'title', 'asc');
                currentPage = 1;
                updateSceneCount();
                displayScenes();
                updatePaginationButtons();
            }

            function displayScenes() {
                sceneTableBody.innerHTML = '';
                const filteredScenes = showOnlyMatches ? currentScenes.filter(scene => scene.status === 'Found') : currentScenes;
                const sortedScenes = sortScenes(filteredScenes);
                const scenesToDisplay = sortedScenes.slice((currentPage - 1) * scenesPerPage, currentPage * scenesPerPage);
            
                scenesToDisplay.forEach(scene => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-scene-id', scene.id);
                    row.setAttribute('data-foreign-guid', scene.foreign_guid);
                    row.innerHTML = `
                        <td>${scene.title}</td>
                        <td>${scene.date}</td>
                        <td>${formatDuration(scene.duration)}</td>
                        <td>${formatPerformers(scene.performers)}</td>
                        <td>${scene.status === 'Found' ? 'Found' : '<i class="fa-solid fa-triangle-exclamation" style="color: red;"></i> Missing'}</td>
                        <td data-column="file_path">${scene.local_path ? `<i class="fa-regular fa-square-check file-path-icon"></i>${scene.local_path}` : ''}</td>
                        <td data-column="foreign_guid">${scene.foreign_guid}</td>
                        <td><button class="btn btn-primary match-button">Match</button></td>
                    `;
                    row.querySelector('.match-button').addEventListener('click', () => handleMatchButtonClick(scene));
                    sceneTableBody.appendChild(row);
                });
            }

            toggleMatchesButton.addEventListener('click', () => {
                showOnlyMatches = !showOnlyMatches;
                displayScenes();
            });

            function sortScenes(scenes) {
                if (sortColumn) {
                    return scenes.sort((a, b) => {
                        let valA = a[sortColumn];
                        let valB = b[sortColumn];

                        if (typeof valA === 'string') {
                            valA = valA.toLowerCase();
                        }
                        if (typeof valB === 'string') {
                            valB.toLowerCase();
                        }

                        if (valA < valB) {
                            return sortDirection === 'asc' ? -1 : 1;
                        }
                        if (valA > valB) {
                            return sortDirection === 'asc' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return scenes;
            }

            function updateSceneCount() {
                const totalScenes = currentScenes.length;
                const matchedScenes = currentScenes.filter(scene => scene.status === 'Found').length;
                sceneCountDisplay.textContent = `${matchedScenes}/${totalScenes} scenes in collection`;
            }

            document.querySelectorAll('th').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-column');
                    if (column) {
                        if (sortColumn === column) {
                            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortColumn = column;
                            sortDirection = 'asc';
                        }
                        displayScenes();
                    }
                });
            });

            pageSizeSelect.addEventListener('change', () => {
                scenesPerPage = parseInt(pageSizeSelect.value, 10);
                displayScenes();
                updatePaginationButtons();
            });

            function formatDuration(minutes) {
                if (typeof minutes !== 'number' || isNaN(minutes)) {
                    return 'N/A';
                }
                const hrs = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hrs > 0 ? hrs + 'h ' : ''}${mins}m`;
            }

            function formatPerformers(performers) {
                return Array.isArray(performers) ? performers.join(', ') : performers;
            }

            async function handleMatchButtonClick(scene) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.mp4';
                input.onchange = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        try {
                            const filePath = homeDirectory ? `${homeDirectory}/${file.webkitRelativePath || file.name}` : file.webkitRelativePath || file.name;
                            const response = await fetch('/match_scene', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ scene_id: scene.id, file_path: filePath })
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`Error ${response.status}: ${errorText}`);
                            }

                            const result = await response.json();

                            // Update the local status and file path of the scene
                            scene.status = 'Found';
                            scene.local_path = filePath;

                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                            }).showToast();
                            displayScenes();
                            enableBulkUpdateButton(); // Re-enable bulk update button
                        } catch (error) {
                            console.error('Error matching scene:', error);
                            Toastify({
                                text: 'Error matching scene: ' + error.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                            }).showToast();
                        }
                    }
                };
                input.click();
            }

            function updatePaginationButtons() {
                firstPageButton.disabled = currentPage === 1;
                prevPageButton.disabled = currentPage === 1;
                nextPageButton.disabled = currentPage === totalPages;
                lastPageButton.disabled = currentPage === totalPages;

                firstPageButton.classList.toggle('disabled', currentPage === 1);
                prevPageButton.classList.toggle('disabled', currentPage === 1);
                nextPageButton.classList.toggle('disabled', currentPage === totalPages);
                lastPageButton.classList.toggle('disabled', currentPage === totalPages);
            }

            firstPageButton.addEventListener('click', () => {
                currentPage = 1;
                displayCollection(currentPage);
            });

            prevPageButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayCollection(currentPage);
                }
            });

            nextPageButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayCollection(currentPage);
                }
            });

            lastPageButton.addEventListener('click', () => {
                currentPage = totalPages;
                displayCollection(currentPage);
            });

            backButton.addEventListener('click', () => {
                siteCollectionContainer.classList.remove('d-none');
                sceneCollectionContainer.classList.add('d-none');
            });

            // Adding active class to site-card on click
            document.querySelectorAll('.site-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.site-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                });
            });

            async function searchStashForMatches() {
                try {
                    if (!currentSiteUuid) {
                        throw new Error('No site selected. Please select a site to search for matches.');
                    }

                    const response = await fetch('/search_stash_for_matches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ site_uuid: currentSiteUuid })
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${await response.text()}`);
                    }

                    const stashMatches = await response.json();
                    updateTableWithStashMatches(stashMatches);
                } catch (error) {
                    console.error('Error searching Stash:', error);
                    Toastify({
                        text: 'Error searching Stash: ' + error.message,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                    }).showToast();
                }
            }

            function updateTableWithStashMatches(stashMatches) {
                sceneTableBody.innerHTML = ''; // Clear the current table body

                stashMatches.forEach(match => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-scene-id', match.scene_id);
                    row.innerHTML = `
                        <td>${match.scene_title}</td>
                        <td>${match.scene_date}</td>
                        <td>${formatDuration(match.scene_duration)}</td>
                        <td>${formatPerformers(match.scene_performers)}</td>
                        <td>${match.scene_status === 'Found' ? 'Found' : '<i class="fa-solid fa-triangle-exclamation" style="color: red;"></i> Missing'}</td>
                        <td data-column="file_path"><i class="fa-regular fa-square-check file-path-icon"></i>${match.matched_title} (${match.matched_file_path})</td>
                        <td data-column="foreign_guid">${match.foreign_guid}</td>
                        <td data-column="action" class="action-buttons">
                            <button class="btn btn-success me-2 confirm-match">Confirm</button>
                            <button class="btn btn-danger cancel-match">Cancel</button>
                        </td>
                    `;

                    row.querySelector('.confirm-match').addEventListener('click', async () => {
                        try {
                            const response = await fetch('/match_scene', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ scene_id: match.scene_id, file_path: match.matched_file_path })
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`Error ${response.status}: ${errorText}`);
                            }

                            const result = await response.json();
                            Toastify({
                                text: result.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)"
                            }).showToast();
                            displayScenes();
                        } catch (error) {
                            console.error('Error confirming match:', error);
                            Toastify({
                                text: 'Error confirming match: ' + error.message,
                                duration: 3000,
                                close: true,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                            }).showToast();
                        }
                    });

                    row.querySelector('.cancel-match').addEventListener('click', () => {
                        filePathCell.innerHTML = '';
                        actionCell.innerHTML = '';
                    });

                    sceneTableBody.appendChild(row);
                });
            }

            document.getElementById('search-stash-button').addEventListener('click', searchStashForMatches);

            // Attach event listener to the search button
            const searchStashButton = document.getElementById('search-stash-button');
            searchStashButton.addEventListener('click', async function() {
                try {
                    console.log('Search Stash button clicked');
            
                    if (!currentSiteUuid) {
                        throw new Error('No site selected. Please select a site to search for matches.');
                    }
            
                    const response = await fetch('/search_stash_for_matches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ site_uuid: currentSiteUuid })
                    });
            
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${await response.text()}`);
                    }
            
                    const stashMatches = await response.json();
                    console.log('Stash matches:', stashMatches);
                    updateTableWithStashMatches(stashMatches);
                    enableBulkUpdateButton(); // Enable bulk update button
                } catch (error) {
                    console.error('Error searching Stash:', error);
                    Toastify({
                        text: 'Error searching Stash: ' + error.message,
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)"
                    }).showToast();
                }
            });
            displayCollection();
        });
    </script>
</body>
</html>
